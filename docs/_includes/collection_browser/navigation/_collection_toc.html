{% capture tocWorkspace %}
  {% comment %}
    1. Get collections levels (if contains any page)
    2. Get categories - or group by categories
    3. Sort posts - i think it's already done by Jekyll
    4. Going post by post, extract headers and assign to the list
  {% endcomment %}

  {% capture my_toc %}{% endcapture %}

  {% assign collection_name = include.collection_name | default: 'posts' %}
  {% assign collection_grouped = site[collection_name] | group_by: 'category' %}
  {% assign sort_by = include.sort_by | default: 'order' %}
  {% assign orderedList = include.ordered | default: false %}
  {% assign minHeader = include.h_min | default: 1 %}
  {% assign maxHeader = include.h_max | default: 6 %}
  {% assign firstHeader = true %}
  {% assign level = 0 %}

  {% assign docHeaderIndentAmount = 1 %}

  {% for category in collection_grouped %}

  {% capture col_id %}{{ collection_name | downcase | replace: ' ', '-' | replace: ':', ''}}{% endcapture %}
  {% capture cat_id %}{{ category.name | downcase | replace: ' ', '-' | replace: ':', ''}}{% endcapture %}

  {% capture category_link %}{{ site.baseurl }}/{{ collection_name }}#{{ category.name }}{% endcapture %}

  {% if site.has_nested_collections_as_categories and site.has_nested_collections_as_categories[collection_name] %}
    {% if site.has_nested_collections_as_categories[collection_name].size > 0 %}
      {% for nested_collection in site.has_nested_collections_as_categories[collection_name] %}
        {% assign v1 = category.name | downcase %}
        {% assign v2 = nested_collection.category_name | downcase %}
        {% if v1 == v2 %}
          {% capture category_link %}{{ site.baseurl }}{{ nested_collection.collection_index_page }}{% endcapture %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}

  {% capture my_toc %}{{ my_toc }}
- <span
  class='nav-collapse-handler category-head collapsed'
  id='cat-nav-id-{{ col_id }}-{{ cat_id }}'
  data-toggle='collapse'
  role='button'
  aria-expanded='false'
  aria-controls='{{ col_id }}-{{ cat_id }}'>
  <span class='arrow-icon glyphicon glyphicon-triangle-bottom'></span>
</span>[{{ category.name | replace: '-',' ' | replace: '%20', ' ' | capitalize }}]({{ category_link }}){% endcapture %}

    {% assign items = category.items | sort: sort_by %}


    {% for doc in items %}

      {% if doc.as_nested_collection %}
        {% comment %}------------------ AS NESTED COLLECTION ------------------{% endcomment %}
        {% assign n_collection = site[doc.as_nested_collection] %}
        {% assign n_collection_name = doc.as_nested_collection %}
        {% assign n_collection_grouped = n_collection | group_by: 'category' %}
        {% assign n_firstHeader = true %}
        {% assign n_cat_indentAmount = 1 %}

        {% capture n_col_id %}{{ n_collection_name | downcase | replace: ' ', '-' | replace: ':', ''}}{% endcapture %}
        {% if doc.act_as_category == false %}
          {% assign n_cat_indentAmount = 0 %}
        {% endif %}

        {% assign n_cat_space = '' %}
        {% for i in (1..n_cat_indentAmount) %}
            {% assign n_cat_space = n_cat_space | prepend: '    ' %}
        {% endfor %}

        {% if doc.act_as_category == false %}
          {% capture my_toc %}{{ my_toc }}
{{ n_cat_space }}- <span
  class='nav-collapse-handler category-head collapsed'
  id='cat-nav-id-{{ n_col_id }}-{{ cat_id }}'
  data-toggle='collapse'
  role='button'
  aria-expanded='false'
  aria-controls='{{ n_col_id }}-{{ cat_id }}'>
  <span class='arrow-icon glyphicon glyphicon-triangle-bottom'></span>
</span>[{{ doc.title }}]({{ site.baseurl }}{{doc.url}}){% endcapture %}
          {% assign n_cat_indentAmount = n_cat_indentAmount | plus: 1 %}
        {% endif %}

        {% for n_category in n_collection_grouped %}

          {% assign n_cat_space = '' %}
          {% for i in (1..n_cat_indentAmount) %}
              {% assign n_cat_space = n_cat_space | prepend: '    ' %}
          {% endfor %}

          {% capture n_col_id %}{{ n_collection_name | downcase | replace: ' ', '-' | replace: ':', ''}}{% endcapture %}
          {% capture n_cat_id %}{{ n_category.name | downcase | replace: ' ', '-' | replace: ':', ''}}{% endcapture %}

    {% capture my_toc %}{{ my_toc }}
{{ n_cat_space }}- <span
  class='nav-collapse-handler category-head collapsed'
  id='cat-nav-id-{{ col_id }}-{{ cat_id }}'
  data-toggle='collapse'
  role='button'
  aria-expanded='false'
  aria-controls='{{ col_id }}-{{ cat_id }}'>
<span class='arrow-icon glyphicon glyphicon-triangle-bottom'></span>
</span>[{{ n_category.name | replace: '-',' ' | replace: '%20', ' ' | capitalize }}]({{ site.baseurl }}/{{ n_collection_name | slugify }}#{{n_category.name}}){% endcapture %}

          {% assign n_items = n_category.items | sort: sort_by %}

          {% for n_doc in n_items %}

            {% capture n_doc_id %}{{ n_doc.title | downcase | replace: ' ', '-' | replace: ':', ''}}{% endcapture %}
            {% capture listModifier %}{% if orderedList %}1.{% else %}-{% endif %}{% endcapture %}
            {% capture n_cont %}{{ n_doc.content }}{% endcapture %}
            {% assign n_cont_md = n_cont | markdownify %}
            {% assign n_nodes = n_cont_md | split: '<h' %}

            {% assign n_cat_space = '' %}
            {% for i in (0..n_cat_indentAmount) %}
                {% assign n_cat_space = n_cat_space | prepend: '    ' %}
            {% endfor %}

            {% capture my_toc %}{{ my_toc }}
{{ n_cat_space }}- <span
  class='nav-collapse-handler category-head collapsed'
  id='cat-nav-id-{{ col_id }}-{{ n_doc_id }}-{{ n_cat_id }}'
  data-toggle='collapse'
  role='button'
  aria-expanded='false'
  aria-controls='{{ doc_id }}-{{ cat_id }}'>
<span class='arrow-icon glyphicon glyphicon-triangle-bottom'></span>
</span>[{{ n_doc.title }}]({{ site.baseurl }}{{ n_doc.url }}){% endcapture %}

            {% for node in n_nodes %}
              {% if node == "" %}
                  {% continue %}
              {% endif %}

              {% assign headerLevel = node | replace: '"', '' | slice: 0, 1 | times: 1 %}

              {% if headerLevel < minHeader or headerLevel > maxHeader %}
                  {% continue %}
              {% endif %}

              {% if firstHeader %}
                  {% assign firstHeader = false %}
                  {% assign minHeader = headerLevel %}
              {% endif %}

              {% assign n_indentAmount = headerLevel | minus: minHeader | plus: docHeaderIndentAmount | plus: n_cat_indentAmount %}
              {% assign _workspace = node | split: '</h' %}

              {% assign _idWorkspace = _workspace[0] | split: 'id="' %}
              {% assign _idWorkspace = _idWorkspace[1] | split: '"' %}
              {% assign html_id = _idWorkspace[0] %}

              {% assign _classWorkspace = _workspace[0] | split: 'class="' %}
              {% assign _classWorkspace = _classWorkspace[1] | split: '"' %}
              {% assign html_class = _classWorkspace[0] %}

              {% if html_class contains "no_toc" %}
                  {% continue %}
              {% endif %}

              {% capture _hAttrToStrip %}{{ _workspace[0] | split: '>' | first }}>{% endcapture %}
              {% assign header = _workspace[0] | replace: _hAttrToStrip, '' %}

              {% assign space = '' %}
              {% for i in (0..n_indentAmount) %}
                  {% assign space = space | prepend: '    ' %}
              {% endfor %}

              {% unless include.item_class == blank %}
                  {% capture listItemClass %}{{ include.item_class | replace: '%level%', headerLevel }}{% endcapture %}
              {% endunless %}

              {% capture heading_body %}{% if include.sanitize %}{{ header | strip_html }}{% else %}{{ header }}{% endif %}{% endcapture %}
              {% capture my_toc %}{{ my_toc }}
{{ space }}{{ listModifier }} <span
  class='nav-collapse-handler category-head collapsed'
  id='cat-nav-id-{{ n_col_id }}-{{ n_doc_id }}-{{ cat_id }}'
  data-toggle='collapse'
  role='button'
  aria-expanded='false'
  aria-controls='{{ n_col_id }}-{{ n_doc_id }}-{{ cat_id }}'>
  <span class='arrow-icon glyphicon glyphicon-triangle-bottom'></span>
</span>[{{ heading_body | replace: "|", "\|" }}]({% if include.baseurl %}{{ include.baseurl }}{% endif %}{{ site.baseurl }}{{n_doc.url}}#{{ html_id }}){% if include.anchor_class %}{:.{{ include.anchor_class }}}{% endif %}{% endcapture %}

            {% endfor %}

          {% endfor %}

        {% endfor %}

        {% comment %}================== END: AS NESTED COLLECTION ============={% endcomment %}
      {% else %}

        {% capture n_cont %}{{ doc.content }}{% endcapture %}
        {% assign n_cont_md = n_cont | markdownify %}
        {% capture listModifier %}{% if orderedList %}1.{% else %}-{% endif %}{% endcapture %}
        {% capture doc_id %}{{ doc.title | downcase | downcase | replace: ' ', '-' | replace: ':', ''}}{% endcapture %}
        {% capture my_toc %}{{ my_toc }}
  - <span
    class='nav-collapse-handler category-head collapsed'
    id='cat-nav-id-{{ doc_id }}-{{ cat_id }}'
    data-toggle='collapse'
    role='button'
    aria-expanded='false'
    aria-controls='{{ doc_id }}-{{ cat_id }}'>
  <span class='arrow-icon glyphicon glyphicon-triangle-bottom'></span>
  </span>[{{ doc.title }}]({{ site.baseurl }}{{ doc.url }}){% endcapture %}
        {% assign nodes = n_cont_md | split: '<h' %}
        {% for node in nodes %}

          {% if node == "" %}
              {% continue %}
          {% endif %}

          {% assign headerLevel = node | replace: '"', '' | slice: 0, 1 | times: 1 %}

          {% if headerLevel < minHeader or headerLevel > maxHeader %}
              {% continue %}
          {% endif %}

          {% if firstHeader %}
              {% assign firstHeader = false %}
              {% assign minHeader = headerLevel %}
          {% endif %}

          {% assign indentAmount = headerLevel | minus: minHeader | plus: docHeaderIndentAmount %}
          {% assign _workspace = node | split: '</h' %}

          {% assign _idWorkspace = _workspace[0] | split: 'id="' %}
          {% assign _idWorkspace = _idWorkspace[1] | split: '"' %}
          {% assign html_id = _idWorkspace[0] %}

          {% assign _classWorkspace = _workspace[0] | split: 'class="' %}
          {% assign _classWorkspace = _classWorkspace[1] | split: '"' %}
          {% assign html_class = _classWorkspace[0] %}

          {% if html_class contains "no_toc" %}
              {% continue %}
          {% endif %}

          {% capture _hAttrToStrip %}{{ _workspace[0] | split: '>' | first }}>{% endcapture %}
          {% assign header = _workspace[0] | replace: _hAttrToStrip, '' %}

          {% assign space = '' %}
          {% for i in (1..indentAmount) %}
              {% assign space = space | prepend: '    ' %}
          {% endfor %}

          {% unless include.item_class == blank %}
              {% capture listItemClass %}{{ include.item_class | replace: '%level%', headerLevel }}{% endcapture %}
          {% endunless %}

          {% capture heading_body %}{% if include.sanitize %}{{ header | strip_html }}{% else %}{{ header }}{% endif %}{% endcapture %}
          {% capture my_toc %}{{ my_toc }}
{{ space }}{{ listModifier }} <span
  class='nav-collapse-handler category-head collapsed'
  id='cat-nav-id-{{ doc_id }}-{{ cat_id }}-{{ increment level }}'
  data-toggle='collapse'
  role='button'
  aria-expanded='false'
  aria-controls='{{ doc_id }}-{{ cat_id }}-{{ increment level }}'>
  <span class='arrow-icon glyphicon glyphicon-triangle-bottom'></span>
</span>[{{ heading_body | replace: "|", "\|" }}]({% if include.baseurl %}{{ include.baseurl }}{% endif %}{{ site.baseurl }}{{doc.url}}#{{ html_id }}){% if include.anchor_class %}{:.{{ include.anchor_class }}}{% endif %}{% endcapture %}

        {% endfor %}

      {% endif %}

    {% endfor %}

  {% endfor %}

  {% if include.class %}
      {% capture my_toc %}{:.{{ include.class }}}
{{ my_toc | lstrip }}{% endcapture %}
  {% endif %}

  {% if include.id %}
      {% capture my_toc %}{: #{{ include.id }}}
{{ my_toc | lstrip }}{% endcapture %}
  {% endif %}


{% endcapture %}
{% assign tocWorkspace = '' %}

{{ my_toc | markdownify | strip }}
